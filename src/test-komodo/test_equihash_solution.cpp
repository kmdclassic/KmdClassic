#include <gtest/gtest.h>
#include "chainparams.h"
#include "core_io.h"
#include "pow.h"
#include "komodo_globals.h"

namespace EquihashSolutionTests
{
    TEST(EquihashSolutionTests, CheckEquihashSolution)
    {
        constexpr const char* blocks[] = {
            "04000000e8963d62f03de4b2ee18bae0c50ed353eff9f3a0a21139fffc38243500000000c7009532d18a29a3d5b38c6e8b20ca0db6cb66b0a9f097d47b87096a67a2cf3aa2d8a734eb73a4dc734072dbfd12406f1e7121bfe0e3d6c10922495c44e5cc1c7790c767d38d011d0b007124b4a9f0aed953cec0d9870a45f2bd2cfd646e5d7ca9ecb0307cb60000fd40050164f2a45e0b4153e76571012fdbaceac5e73ea7f503f0997f784ff195c567c3682d576a49ee14b9191c1cdd930cfa4ec36c8cbf76cb936e9dbafed87c4d3b2399fc755067bdcfd65a348a6f40d125b64b7dc6e509c7f42afea2f977992714ee8563c67198a1b2cb9c0e74c14304e867f5c2beb14094465fe1ddabb4fa380ce61551f7cde9568680e2f17b4f092a2238b89e4413e14fbba3a3d45d2339a355c9b1eddf16739ce40e02cc0259831141f5247570bf046fe319a7d390915f4834131c65d62a4bed974576bdee205669e5fa37ba1346ffda74302fe5bd95a2881ba29fd9454139110c2fa6e63a552990e75680643775b03acdabc5bf8bdb07102792ea5ae1ed1771b5429055aea32b1cbd2eb50c2743f8a44cd72d8973417ecf5f977915a438290718a923940eabd703a7b2c553eb658f8def417116c241209226026271eb86eaf58f6cf474e6d9d1d6dbc902e834b683ab33b5f7d74b306159ab86dd461c79771e0ac9d8a663cdd5a005a5f6bf5e80098068bc972a04640e2a750fcc78def7024442b71fd2909d37835b05c0dcc9eed0aa26d69814fd97adce8194b070317804970318f953bed1dcf750944d66c2fc6553b0f7212772918e7b4adfb467ef565cddd83a672ebcfcef751d156c1c110c33770017d65b4cc6f316bc3dda6a3b5c52f65cee235c3953bf5b789f6e66530d02db4fff039e5d0bca5532ffc7cff14a2ae4660cfcac1fb24039ba273a015294c5591407271fd49a0e3f54d7a97f0d28e873031d104d106a31ae707cdd58f22a33c81c170d99133fa9c03dce3f9397f33264f59408af326204b821bb742916db52d2522e3be5b460d4b20b8d5113c37a3d72229af78133e2f0cfffe38d96c3ef4f2a0d22adde9fd151a6f77076fb03de9b5643dc7af2330e796c69ecf1220f99f8e1bb0dca2ff6727aba26d401b6ceefec914f9304fb94bdf3fd50b67a973eb2e20bda8ae8d7aa696db86df31feedc004e3803d926820aa28b7f36039dd18427b41f837c6fad9bc38f4b991dbc191e39df971557b503a1122b7286f8ac9ef4e00ad1b5c1dc54ddfabc07897d82e9e53a7507df276f0ee50601d62e5af9fc35f45c10fb61ba14c7515a6b240569ff6c92442f4575d2dfa62399450d0b730dbc2cd566ad045b231711a244e4fee566eb292edb3590121e0742e20d8146e53f719508e72010acf40978a3374d8adfece6115fe74df57bd8604e4579c68dbc9c174e7d93124ca3919d6589209951e156541b733b24299b1b27e9de98cf0b1862d30d5f875166d798af64170fb5ec7f13b781672418580ce8f2f68b10de3c31542827c6f4d724b78fd0f5edc772a15763f4fbb512334ca6b5e6a6eb0f84af23451cc81598f55b30a85d4c0762dfb62e0267e28dfa496a5a301ab80edc01ea02a4bdfbb292aed76794a0e95eff5bb1c973da1a2a0c0d6190062d6869a176614911bbdc0cdff3f52c4702d82c273bcbd1a4fb746163074f89cdcff63be4093ff16eab122958bbcd0a352bf4fa3ca78b89bf684a0b97e2052ceaa8779adff4370d29d125d4ae3cca492c7d577e38ce9780e7823342fd7779eab00c7b89ad0fe5dfd73ecde61ba89157c086f2a7567559b59dfc3c9ce581049baab95041f60d223a8339f64456582406ed303d4d5991396ff4e60964376c7b4f8c5c349b3ad6022d569e96c1598193b3b93547babe47b89ce7169412affd4cd2308fee62745dc63f72bc51fae5ee3b54359458e78ed7cc52a3b643c0169a20fb74a6c412f555b3386fbe258ac101bfb913642e0d619a4b4c1338b913ed203b3d483c42774c407d44bbb2dc24bb3ff8620c66932bd6f007b5b731bd8d5d79105cb0ad60610462ae320f4badad27319dc90895d5e6d99fc2020400008085202f89010000000000000000000000000000000000000000000000000000000000000000ffffffff06039931420101ffffffff0200e1f50500000000232103d224790d17b881db560759cc9cc73fe5c865136a88af471ea156b7eb6d88ce32ac8813000000000000016a3990c7670000000000000000000000000000000400008085202f89014974ceb9a1daf6233e604ba5ba2dc75665a6900a64412c3101a6264c78f7d75c0700000049483045022100dc530179d51da04b066f77d647284200f3c208d3377f2026033e0f826566baab02202a9dd05c0420ee1391468bf03c18e54c6307b44758f42b888197c672d1bfdd2e01ffffffff0288130000000000002321020e46e79a2a8d12b9b5d12c7a91adb4e454edfae43c0a0cb805427d2ac7613fd9ac0000000000000000226a20cd036a513e3abff6bd4c0fa65fbccb7d87d504a331e4f4a15572760cfa3c8fb77790c767613242000000000000000000000000", // #4338073
            "04000000eeebe32ad19a438464d4fc0d5f18f8da82d8d8928a726f9cc156e6c276a47a07ad8dc3221e23e2f4b61d0339838486f1a672ebcb8646f9915a0764f656667e4da2d8a734eb73a4dc734072dbfd12406f1e7121bfe0e3d6c10922495c44e5cc1c229bc8670049011d05002bbeda546f9dca91ba970b235126e302bf59f2a6ca54b09442884a500000fd40050007fac99643eebdcfd286ca66f67e0db887dd904910976dbe0b1cfd17d30558ac995a66ee96239b6d86044f4b893aeba03faccf23feea5d34de0226f9552d0552e1996ea931299d5846a89a3c7833d3729f212f0025864c853405c7ba7ab33d052622ba077d5e5afd0b810181888625010f94a1e3a3ea72c09ad93a16c7200aaa3cf1b1c67fcf937664d6cded1ea9e2b837c072c09fc2ce314185f00d77ad6bbf6ce6ad0a37f774072a69e3ebb452bde3fb108fb45600085fcdb7db8751e56d620f6f2b07e7602903d271fdd252b21383450acbea29b0e8f1bde788a2d2e65fcfa5d200befa5c0ddc860ff4df74ebe79b36ba9869623ad8455d4e89091a0fa6230b12b3148f86409ef38ac9ade3d79e6e3b58164ba32994eda22eb571fc739d864d6ab55369501e633221548076cbd585e4de342c9bada6fee5de6d3775331fde1b5d8d942845c8d3e9baa8ebb8599700f32bcf225c96eb7724621c6e204a0de786309cf62759742462191f8ee3ccc2c65031f2fcea112bad2108c05658328de0252460147d767fda1d862c5c42f136c6af28ace7fb5595c144baafad20a3a8829dce62056fdc1576b84d63e038c2309e3df4c90b19f2d3220fe1524e9f154a9d04909289d8f15754a4c9cb11650da34872a409c774bcdae44365c9d2fd78ba9cdddb38a993459e6e0851ea4b1785f96d97beb804bf65e001bdd63b1663ca53812da34482ebb53d617d3099a01b71c1e61599cb453153163cc134fc79e687777c19084a6f9d11e19563149cf304c0217be8e0b4788ca8135d96dfa72730ab63b4f1cde44e5dbe074f58a49502e999c4ca6000ad7efe11f83b3212d6020776e6d0388b1dd863a619a16401d3b20c3572511d8ccac9c5033921249bc19343401be5d81547b7b195535dda520b8f708816d81b135992233c4c78394cd288fb86bc001a229aab094819a6f6437fd4c9ee0624f4d4a19114c5a6561306de519026b45bfcb583567685f8226406d7f66693a7289dabb7f4e4895b8d11ae691e3f3725c583ff83da0d1350726391ebb342de3a90f7147901ab3be3b94b65899fbdd09d2dcd10852ac6779a4c0386c21ee66aa9cd738c318b9c33b1b4dfbb3ab4ba04b423991f022bb67fc940b72890c8e93dc09fad3217241dcf0d677833c0c7d4094a503b8b5e66fe33a900cda970211a0779bc075a286cf321eb68bcde431610abc266978b4998c3a3c5466d425a226d95d8b0b6217c4aa5f8a1057ba0c7e5a899f239b269e8b3699322f04960db8c33d8b5b0bcff38f1da8b431b3cd1cc03244be6ab438fb3c847a6ca64d7ae8a93c83d815d050b9cae2883781ba3c6535fd96bde596e021f65ad2416431ba1b2b01bf2f258b3d7e94ab6c0eb38a56d2db1031a26a73ecdce6fc4227fb0c9691912d508bd00d4ffb0809178e3b13571017eec3abca9e9bfa9c40ada7e16f143db969f4971784f745b2077d530d1560835c181ea78728de843f8d3a160742b7964fc06691005f7d5f9102cb3b5efd4b9bef47a76dc3a17cc06035c0357bdac914f85d611a1b8a192da70a4d97f7e094234116b21aa5d519eb95b27cebf0e690896a36c07e252fe68e50ab1abf6f48a5d5eb7b9b397f695f118844c1db849a3d56170b50a3fc2808707b21c1aaf0d01aef43006f19b011232dd65ccc67613eab41df721483267d4ceaf411a8122b7f724680d14fff304ca42fc3f02feb84a97c5ecf60f59f74a9f873e3f2a7875bccf11852a143784c228865e51109a50165b1b0625df01e047531246e87e02d3494622d2204ef3389954ef458689206a1d895ec5befb77c4fb69763febb037a7c4e8e8a4fb1f951b36cdcb4a7b5e7ff114fde74f416f0201e5b00d30688ac6d77b930b4e2f1ea93d020400008085202f89010000000000000000000000000000000000000000000000000000000000000000ffffffff0603f435420101ffffffff0200e1f505000000002321035baa12331ad6c284d5f1b76527c1d6c5eb15a74b9ba369e5d46aefcc9c120938ac8813000000000000016a8299c8670000000000000000000000000000000400008085202f890119592a2b1554a98d1a0a8673114290f70228e3a51fb2444c2f680b31b98486260c0000004847304402205d822bbc33d817a4d605d15302bc4f32b20f302c3aab7e576dfae9621ed6107902207270cdb90de38377321f7f4feae236388ccc2ed7bb2934de5437f540a578fc3301ffffffff0288130000000000002321020e46e79a2a8d12b9b5d12c7a91adb4e454edfae43c0a0cb805427d2ac7613fd9ac0000000000000000226a20ddddf80dca9a92444d64725c7e6637daa0dedbf524defeb731a44772e635af0c229bc867bc3642000000000000000000000000"    // #4339188
        };

        SelectParams(CBaseChainParams::MAIN);
        CChainParams params = Params();

        // make sure we will not skip actual checks in CheckEquihashSolution
        ASSERT_TRUE(Params().NetworkIDString() == "main");
        ASSERT_TRUE(ASSETCHAINS_ALGO == _ASSETCHAINS_EQUIHASH);
        ASSERT_TRUE(ASSETCHAINS_NK[0] == 0 && ASSETCHAINS_NK[1] == 0);
        ASSERT_TRUE(params.EquihashN() == 200 && params.EquihashK() == 9);

        for (const char* hexblock : blocks)
        {
            CBlock block;
            ASSERT_TRUE(DecodeHexBlk(block, hexblock));
            ASSERT_TRUE(CheckEquihashSolution(&block, params));
            // try to corrupt one random byte in solution
            std::vector<unsigned char> nSolutionOrg = block.nSolution;
            std::srand(static_cast<unsigned int>(std::time(nullptr)));
            size_t idx = std::rand() % block.nSolution.size();
            unsigned char newByte;
            do
            {
                newByte = static_cast<unsigned char>(std::rand() % 256);
            } while (newByte == block.nSolution[idx]);
            block.nSolution[idx] = newByte;
            ASSERT_TRUE(nSolutionOrg != block.nSolution);
            ASSERT_FALSE(CheckEquihashSolution(&block, params));
        }
        SelectParams(CBaseChainParams::REGTEST);
    }
}